<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Migros Market Arabası Takip Sistemi</title>
  <style>
    body { font-family: Arial; margin: 0; padding: 0; background: #f0f0f0; }
  header { background: #ee7624; color: white; text-align: center; padding: 1rem; }
    main {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      justify-content: flex-start;
      padding: 0;
      gap: 2rem;
      height: calc(100vh - 70px);
      min-height: 600px;
    }
    #store-map {
      position: relative;
      width: 1400px;
      height: calc(100vh - 70px);
      min-height: 600px;
      border: 2px solid #ccc;
      background-color: #fff;
      margin-top: 0;
      margin-left: 0;
      box-sizing: border-box;
    }
    .cart {
      position: absolute;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      z-index: 2;
    }
    .shelf {
      position: absolute;
      background: #ffe0b2;
      border: 2px solid #ee7624;
      border-radius: 8px;
      z-index: 1;
    }
    #controls {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      background: #fff3e0;
      border: 2px solid #ee7624;
      border-radius: 12px;
      padding: 2rem 1.5rem;
      min-width: 220px;
      align-items: stretch;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    button {
      padding: 0.7rem 1rem;
      font-size: 1rem;
      cursor: pointer;
      border: none;
      border-radius: 6px;
      background: #ee7624;
      color: #fff;
      font-weight: bold;
      transition: background 0.2s;
    }
    button:hover {
      background: #d65d0e;
    }
    #cart-list-panel {
      background: #fff3e0;
      border: 2px solid #ee7624;
      border-radius: 12px;
      min-width: 220px;
      max-width: 260px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      height: 500px;
    }
    .cart-list-title {
      font-size: 1.1rem;
      font-weight: bold;
      color: #ee7624;
      background: #fff;
      border-radius: 12px 12px 0 0;
      padding: 1rem 1rem 0.7rem 1rem;
      text-align: center;
      border-bottom: 1.5px solid #ee7624;
    }
    .cart-list-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 0.7rem 1rem 1rem 1rem;
      background: #fff3e0;
      border-radius: 0 0 12px 12px;
    }
    .cart-list-item {
      font-size: 1rem;
      color: #333;
      background: #fff;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      padding: 0.5rem 0.8rem;
      border: 1px solid #ee7624;
      font-weight: 500;
      box-shadow: 0 1px 2px rgba(0,0,0,0.03);
      cursor: pointer;
    }
    .cart-list-item.connected {
      background: #ee7624;
      color: #fff;
      border: 2px solid #ee7624;
      font-weight: bold;
      cursor: pointer;
    }
    .cart-list-popup {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .cart-list-popup-content {
      background: #fff;
      border-radius: 12px;
      padding: 2rem 2.5rem;
      min-width: 260px;
      box-shadow: 0 4px 32px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.2rem;
    }
    .cart-list-popup-content button {
      width: 100%;
      margin-top: 0.5rem;
      padding: 0.7rem 0;
      font-size: 1rem;
      border-radius: 7px;
      border: none;
      background: #ee7624;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    .cart-list-popup-content button:hover {
      background: #d65d0e;
    }
    .cart-list-popup-content .popup-title {
      font-size: 1.1rem;
      font-weight: bold;
      color: #ee7624;
      margin-bottom: 0.5rem;
    }
    .cart-list-popup-content .popup-warning {
      color: #d32f2f;
      font-size: 1.05rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
  </style>
</head>
<body>
  <header>
  <div style="display: flex; align-items: center; justify-content: center; gap: 1.5rem; position: relative;">
      <svg width="260" height="60" viewBox="0 0 520 120" xmlns="http://www.w3.org/2000/svg">
        <text x="0" y="95" font-family="Arial Black, Arial, sans-serif" font-size="100" font-weight="bold" fill="#fff">MiGROS</text>
      </svg>
      <span style="font-size: 2.1rem; font-weight: bold; letter-spacing: 1px; color: #fff;">MARKET ARABASI TAKİP SİSTEMİ</span>
      <button id="logout-btn" style="position: absolute; top: 10px; right: 0; background: #d32f2f; color: #fff; font-weight: bold; font-size: 1.1rem; border: none; border-radius: 8px; padding: 0.6rem 1.5rem; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">Çıkış Yap</button>
      <button id="logout-btn" style="position: absolute; top: 10px; right: 0; background: #d32f2f; color: #fff; font-weight: bold; font-size: 1.1rem; border: none; border-radius: 8px; padding: 0.6rem 1.5rem; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">Çıkış Yap</button>
    </div>
  </header>
  <main>
    <div id="store-map"></div>
    <div style="display: flex; flex-direction: column; gap: 2rem;">
      <div id="controls">
        <button id="connect-btn">BLE Cihazına Bağlan</button>
        <button id="toggle-sim">Takibi Aç/Kapa</button>
        <button id="toggle-heatmap">Isı Haritasını Göster</button>
      </div>
      <div id="cart-list-panel">
        <div class="cart-list-title">Takip Edilen Market Arabaları</div>
        <div class="cart-list-scroll">
          <!-- Market Arabası görselleri kaldırıldı. Bağlı/bağlı değil durumu için resimler JS ile eklenecek. -->
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/heatmapjs@2.0.5/heatmap.min.js"></script>
  <script>
    // Çıkış butonu fonksiyonu
    document.addEventListener('DOMContentLoaded', function() {
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.onclick = function() {
          // Önce varsa eski popup'ı kaldır
          const oldPopup = document.getElementById('logout-popup');
          if (oldPopup) oldPopup.remove();
          // Popup oluştur
          const popup = document.createElement('div');
          popup.id = 'logout-popup';
          popup.style.position = 'fixed';
          popup.style.top = '0';
          popup.style.left = '0';
          popup.style.width = '100vw';
          popup.style.height = '100vh';
          popup.style.background = 'rgba(0,0,0,0.25)';
          popup.style.display = 'flex';
          popup.style.alignItems = 'center';
          popup.style.justifyContent = 'center';
          popup.style.zIndex = '9999';
          const content = document.createElement('div');
          content.style.background = '#fff';
          content.style.padding = '2.2rem 2.5rem 1.5rem 2.5rem';
          content.style.borderRadius = '16px';
          content.style.boxShadow = '0 4px 32px rgba(0,0,0,0.13)';
          content.style.display = 'flex';
          content.style.flexDirection = 'column';
          content.style.alignItems = 'center';
          content.innerHTML = `<div style='font-size:1.15rem;color:#d32f2f;font-weight:600;margin-bottom:1.2rem;text-align:center;'>Çıkış yapmak istediğinize emin misiniz?</div>`;
          const btnYes = document.createElement('button');
          btnYes.textContent = 'Evet';
          btnYes.style.background = '#d32f2f';
          btnYes.style.color = '#fff';
          btnYes.style.fontWeight = 'bold';
          btnYes.style.fontSize = '1.1rem';
          btnYes.style.border = 'none';
          btnYes.style.borderRadius = '7px';
          btnYes.style.padding = '0.7rem 2.5rem';
          btnYes.style.cursor = 'pointer';
          btnYes.style.marginTop = '0.5rem';
          btnYes.onclick = function() {
            window.location.href = 'giris.html';
          };
          const btnNo = document.createElement('button');
          btnNo.textContent = 'Hayır';
          btnNo.style.background = '#ee7624';
          btnNo.style.color = '#fff';
          btnNo.style.fontWeight = 'bold';
          btnNo.style.fontSize = '1.1rem';
          btnNo.style.border = 'none';
          btnNo.style.borderRadius = '7px';
          btnNo.style.padding = '0.7rem 2.5rem';
          btnNo.style.cursor = 'pointer';
          btnNo.style.marginTop = '0.5rem';
          btnNo.onclick = function() {
            popup.remove();
          };
          content.appendChild(btnYes);
          content.appendChild(btnNo);
          popup.appendChild(content);
          document.body.appendChild(popup);
        };
      }
    });
  </script>
  <script>
    // Çıkış butonu fonksiyonu
    document.addEventListener('DOMContentLoaded', function() {
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.onclick = function() {
          // Önce varsa eski popup'ı kaldır
          const oldPopup = document.getElementById('logout-popup');
          if (oldPopup) oldPopup.remove();
          // Popup oluştur
          const popup = document.createElement('div');
          popup.id = 'logout-popup';
          popup.style.position = 'fixed';
          popup.style.top = '0';
          popup.style.left = '0';
          popup.style.width = '100vw';
          popup.style.height = '100vh';
          popup.style.background = 'rgba(0,0,0,0.25)';
          popup.style.display = 'flex';
          popup.style.alignItems = 'center';
          popup.style.justifyContent = 'center';
          popup.style.zIndex = '9999';
          const content = document.createElement('div');
          content.style.background = '#fff';
          content.style.padding = '2.2rem 2.5rem 1.5rem 2.5rem';
          content.style.borderRadius = '16px';
          content.style.boxShadow = '0 4px 32px rgba(0,0,0,0.13)';
          content.style.display = 'flex';
          content.style.flexDirection = 'column';
          content.style.alignItems = 'center';
          content.innerHTML = `<div style='font-size:1.15rem;color:#d32f2f;font-weight:600;margin-bottom:1.2rem;text-align:center;'>Çıkış yapmak istediğinize emin misiniz?</div>`;
          const btnYes = document.createElement('button');
          btnYes.textContent = 'Evet';
          btnYes.style.background = '#d32f2f';
          btnYes.style.color = '#fff';
          btnYes.style.fontWeight = 'bold';
          btnYes.style.fontSize = '1.1rem';
          btnYes.style.border = 'none';
          btnYes.style.borderRadius = '7px';
          btnYes.style.padding = '0.7rem 2.5rem';
          btnYes.style.cursor = 'pointer';
          btnYes.style.marginTop = '0.5rem';
          btnYes.onclick = function() {
            window.location.href = 'giris.html';
          };
          const btnNo = document.createElement('button');
          btnNo.textContent = 'Hayır';
          btnNo.style.background = '#ee7624';
          btnNo.style.color = '#fff';
          btnNo.style.fontWeight = 'bold';
          btnNo.style.fontSize = '1.1rem';
          btnNo.style.border = 'none';
          btnNo.style.borderRadius = '7px';
          btnNo.style.padding = '0.7rem 2.5rem';
          btnNo.style.cursor = 'pointer';
          btnNo.style.marginTop = '0.5rem';
          btnNo.onclick = function() {
            popup.remove();
          };
          content.appendChild(btnYes);
          content.appendChild(btnNo);
          popup.appendChild(content);
          document.body.appendChild(popup);
        };
      }
    });
  </script>
  <script>
    const storeMap = document.getElementById('store-map');

    // Arabalar ve konumları
    // Reyonlar (örnek: x, y, genişlik, yükseklik)
    const shelves = [
      { x: 60, y: 60, w: 120, h: 30 },
      { x: 60, y: 120, w: 120, h: 30 },
      { x: 220, y: 60, w: 120, h: 30 },
      { x: 220, y: 120, w: 120, h: 30 },
      { x: 400, y: 60, w: 150, h: 30 },
      { x: 400, y: 120, w: 150, h: 30 },
      { x: 60, y: 220, w: 490, h: 30 },
      { x: 60, y: 320, w: 490, h: 30 },
      { x: 60, y: 420, w: 490, h: 30 },
    ];

    let carts = [
      { id: 1, x: 80, y: 70 },
      { id: 2, x: 250, y: 130 },
      { id: 3, x: 420, y: 70 },
    ];

  let simulation = true;
  let heatmapVisible = true;

    // Heatmap ayarları
    const heatmap = h337.create({
      container: storeMap,
      radius: 50,
      maxOpacity: 0.6,
      minOpacity: 0,
      blur: 0.75,
    });

    function renderCarts() {
      storeMap.innerHTML = '';
      // Reyonları çiz
      shelves.forEach(shelf => {
        const shelfEl = document.createElement('div');
        shelfEl.classList.add('shelf');
        shelfEl.style.left = shelf.x + 'px';
        shelfEl.style.top = shelf.y + 'px';
        shelfEl.style.width = shelf.w + 'px';
        shelfEl.style.height = shelf.h + 'px';
        storeMap.appendChild(shelfEl);
      });
      // Arabaları çiz
      carts.forEach(cart => {
        const cartEl = document.createElement('div');
        cartEl.classList.add('cart');
        cartEl.style.left = cart.x + 'px';
        cartEl.style.top = cart.y + 'px';
        cartEl.style.backgroundColor = `rgb(${Math.floor(cart.x/3)},0,${255-Math.floor(cart.y/2)})`;
        cartEl.textContent = cart.id;
        storeMap.appendChild(cartEl);
      });
      // Heatmap güncelle
      if (heatmapVisible) {
        heatmap.setData({
          max: 10,
          data: carts.map(c => ({ x: c.x + 20, y: c.y + 20, value: 5 }))
        });
        heatmap._renderer.canvas.style.display = '';
      } else {
        heatmap._renderer.canvas.style.display = 'none';
      }
    }

    renderCarts();

    function moveCarts() {
      if(!simulation) return;
      carts.forEach(cart => {
  cart.x += Math.floor(Math.random() * 11 - 5);
  cart.y += Math.floor(Math.random() * 11 - 5);
  cart.x = Math.max(0, Math.min(1360, cart.x));
  cart.y = Math.max(0, Math.min(storeMap.offsetHeight - 40, cart.y));
      });
      renderCarts();
    }

    setInterval(moveCarts, 1000);

    // Simülasyonu aç/kapa
    document.getElementById('toggle-sim').addEventListener('click', () => {
      simulation = !simulation;
    });

    // Isı haritası göster/gizle
    document.getElementById('toggle-heatmap').addEventListener('click', () => {
      heatmapVisible = !heatmapVisible;
      renderCarts();
      document.getElementById('toggle-heatmap').textContent = heatmapVisible ? 'Isı Haritasını Gizle' : 'Isı Haritasını Göster';
    });

    // BLE cihazına bağlan (Web Bluetooth API simülasyonu)
    document.getElementById('connect-btn').addEventListener('click', async () => {
      try {
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: ['battery_service'] // Örnek servis
        });
        // Sıradaki arabaya ata
        if (nextCartIndex < cartCount) {
          connectedCarts[nextCartIndex] = true;
          cartListItems[nextCartIndex].classList.add('connected');
          nextCartIndex++;
        }
        alert('BLE cihazına bağlandı: ' + device.name);
      } catch (error) {
        alert('BLE bağlantısı başarısız: ' + error);
      }
    });

    // Takip edilen market arabaları listesini doldur
    const cartListScroll = document.querySelector('.cart-list-scroll');
    const cartCount = 50;
    const cartListItems = [];
    let connectedCarts = [];
    for(let i=1; i<=cartCount; i++) {
  const item = document.createElement('div');
  item.className = 'cart-list-item';
  item.style.display = 'flex';
  item.style.alignItems = 'center';
  item.style.justifyContent = 'space-between';
  // Sol bağlantı ikonu (küçük daire)
  const icon = document.createElement('span');
  icon.className = 'cart-status-icon disconnected';
  icon.title = 'Bağlı değil';
  item.appendChild(icon);
  // Metin
  const label = document.createElement('span');
  label.textContent = `Market Arabası ${i.toString().padStart(2, '0')}`;
  label.style.flex = '1';
  label.style.marginLeft = '8px';
  item.appendChild(label);
  // Bağlı/bağlı değil görseli kaldırıldı. Sadece arka plan ve metin olacak.
  // Zincir simgesi kaldırıldı.
  item.dataset.cartIndex = i-1;
  cartListScroll.appendChild(item);
  cartListItems.push(item);
    }

    // Popup fonksiyonu
    function showCartPopup(index) {
      // Popup zaten varsa kaldır
      const oldPopup = document.getElementById('cart-list-popup');
      if (oldPopup) oldPopup.remove();
      const item = document.createElement('div');
      item.className = 'cart-list-item';
      item.style.display = 'flex';
      item.style.alignItems = 'center';
      item.style.justifyContent = 'center';
      // Sadece metin
      const label = document.createElement('span');
      label.textContent = `Market Arabası ${i.toString().padStart(2, '0')}`;
      label.style.flex = '1';
      label.style.marginLeft = '8px';
      item.appendChild(label);
      item.dataset.cartIndex = i-1;
      cartListScroll.appendChild(item);
      cartListItems.push(item);
    }

    // Tıklanabilirlik
    cartListItems.forEach((item, idx) => {
      // Zincir ikonuna tıklama
      const chain = item.querySelector('.cart-chain-icon');
      chain.onclick = (e) => {
        e.stopPropagation();
        if (connectedCarts[idx]) {
          showCartPopup(idx);
        } else {
          showDisconnectedWarning();
        }
      };
      // Satırın tamamına tıklama
      item.onclick = (e) => {
        // Zincir ikonuna tıklanmadıysa
        if (!chain.contains(e.target)) {
          if (connectedCarts[idx]) {
            showCartPopup(idx);
          } else {
            showDisconnectedWarning();
          }
        }
      };
    });

    // BLE cihazı bağlandığında sıradaki arabaya ata
    let nextCartIndex = 0;
    connectedCarts = Array(cartCount).fill(false);
    document.getElementById('connect-btn').addEventListener('click', async () => {
      try {
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: ['battery_service']
        });
        // Sıradaki arabaya ata
        if (nextCartIndex < cartCount) {
          connectedCarts[nextCartIndex] = true;
          cartListItems[nextCartIndex].classList.add('connected');
          // Bağlantı ikonunu güncelle
          const icon = cartListItems[nextCartIndex].querySelector('.cart-status-icon');
          if (icon) {
            icon.classList.remove('disconnected');
            icon.classList.add('connected');
            icon.title = 'Bağlı';
          }
          // Durum görselini güncelle
          const statusImg = cartListItems[nextCartIndex].querySelector('img');
          if (statusImg) {
            statusImg.src = 'yesil.png';
            statusImg.alt = 'Bağlı';
          }
          // Zincir ikonunu güncelle
          const chain = cartListItems[nextCartIndex].querySelector('.cart-chain-icon');
          if (chain) {
            chain.classList.remove('disconnected');
            chain.classList.add('connected');
            chain.querySelectorAll('path').forEach(p => {
              p.setAttribute('stroke', '#4caf50');
            });
          }
          nextCartIndex++;
        }
        alert('BLE cihazına bağlandı: ' + device.name);
      } catch (error) {
        alert('BLE bağlantısı başarısız: ' + error);
      }
    });
    // Bağlantı durumu zincir ikonlarını başlat
    cartListItems.forEach((item, idx) => {
      const chain = item.querySelector('.cart-chain-icon');
      if (chain) {
        chain.classList.remove('connected');
        chain.classList.add('disconnected');
        chain.querySelectorAll('path').forEach(p => {
          p.setAttribute('stroke', '#f44336');
        });
      }
    });

    // Bağlı değil uyarı popup'ı
    function showDisconnectedWarning() {
      const oldPopup = document.getElementById('cart-disconnected-popup');
      if (oldPopup) oldPopup.remove();
      const popup = document.createElement('div');
      popup.id = 'cart-disconnected-popup';
      popup.style.position = 'fixed';
      popup.style.top = '0';
      popup.style.left = '0';
      popup.style.width = '100vw';
      popup.style.height = '100vh';
      popup.style.background = 'rgba(0,0,0,0.25)';
      popup.style.display = 'flex';
      popup.style.alignItems = 'center';
      popup.style.justifyContent = 'center';
      popup.style.zIndex = '9999';
      const content = document.createElement('div');
      content.style.background = '#fff';
      content.style.padding = '2.2rem 2.5rem 1.5rem 2.5rem';
      content.style.borderRadius = '16px';
      content.style.boxShadow = '0 4px 32px rgba(0,0,0,0.13)';
      content.style.display = 'flex';
      content.style.flexDirection = 'column';
      content.style.alignItems = 'center';
      content.innerHTML = `<div style='font-size:1.15rem;color:#d32f2f;font-weight:600;margin-bottom:1.2rem;text-align:center;'>Makret Arabası Şu Anda Bağlı Değil<br>Bağlantıyı Kontrol Edip Tekrar Deneyin</div>`;
      const btn = document.createElement('button');
      btn.textContent = 'Tamam';
      btn.style.background = '#ee7624';
      btn.style.color = '#fff';
      btn.style.fontWeight = 'bold';
      btn.style.fontSize = '1.1rem';
      btn.style.border = 'none';
      btn.style.borderRadius = '7px';
      btn.style.padding = '0.7rem 2.5rem';
      btn.style.cursor = 'pointer';
      btn.style.marginTop = '0.5rem';
      btn.onclick = () => popup.remove();
      content.appendChild(btn);
      popup.appendChild(content);
      document.body.appendChild(popup);
    }
</script>
</body>
</html>
